# Содержание
1. Среди брокеров есть Contoller
2. Отличие между паттернами Outbox и Inbox
    1. Outbox Pattern
    2. Основные функции Outbox Pattern
    3. Как это работает: Outbox Pattern
    4. Inbox Pattern
    5. Основные функции Inbox Pattern
    6. Как это работает: Inbox Pattern
    7. Краткое сравнение Outbox и Inbox
3. Partitions (FIFO in partitions)
4. Data Storage
5. Storage Segments
6. Removing Data
7. Replication
8. Leader replicas
9. Синхронизация Leader & Follower
    1. Назначаем ISR (in-sync replicas) реплики
    2. ISR реплика
10. ACKS


# Среди брокеров есть Contoller
Он управляет различной конфигурацией кластера, например, назначает LEADER реплики партиций

# Отличие между паттернами Outbox и Inbox заключается в их назначении и области применения:

## Outbox Pattern
### **Назначение:** Обеспечение атомарной передачи данных между базой данных и системой сообщений (например, Kafka).

### Основные функции:

1. Гарантия доставки данных: Outbox обеспечивает, что изменения в базе данных и отправка сообщений в Kafka выполняются как единая транзакция. Это предотвращает ситуации, когда данные обновлены, но сообщение не было отправлено, и наоборот.

2. Атомарность: Все операции выполняются атомарно, то есть либо все изменения применяются, либо ничего не применяется.

### Как это работает:

- Изменения данных сначала сохраняются в таблицу outbox.

- Фоновый процесс или сервис периодически читает сообщения из таблицы outbox и отправляет их в Kafka.

- После успешной отправки сообщение помечается как обработанное.

## Inbox Pattern

### **Назначение:** Обеспечение идемпотентности при обработке входящих сообщений, чтобы одно и то же сообщение не обрабатывалось несколько раз.

### Основные функции:

1. Идемпотентность: Inbox обеспечивает, что каждое сообщение обрабатывается только один раз, даже если оно было получено несколько раз.

2. Предотвращение дублирования: За счет проверки наличия идентификатора сообщения в таблице inbox, можно избежать повторной обработки одного и того же сообщения.

### Как это работает:

- При получении сообщения из Kafka, его идентификатор сохраняется в таблицу inbox.

- Сообщение обрабатывается только в том случае, если его идентификатор отсутствует в таблице inbox.

- После успешной обработки идентификатор сообщения сохраняется в inbox, чтобы предотвратить повторную обработку.

### Краткое сравнение
- Outbox: Обеспечивает атомарность и надежность при отправке сообщений от базы данных в Kafka.

- Inbox: Обеспечивает идемпотентность и предотвращает дублирование при обработке входящих сообщений из Kafka.

Эти паттерны дополняют друг друга и помогают создать надежную и согласованную систему обмена сообщениями в распределенных системах.

## Partions (FIFO in partitions)

![image](https://github.com/user-attachments/assets/4d563c95-1e25-4222-8a8c-e913f99d9559)

## Data Storage

![image](https://github.com/user-attachments/assets/7e2a77a2-2b28-49b9-afa9-fa986404b4fd)

## Storage Segments

![image](https://github.com/user-attachments/assets/dbdaf1ed-64e7-444f-badd-c24d6bdde481)

## Removing Data

![image](https://github.com/user-attachments/assets/0c62e90b-c6a9-4af1-92c2-45d1bbdf5fa5)

Если сегменты не удаляются, значит в них есть какие-то события, у которых timestamp проставлен как далекое будущее

## Replication
Replication-factor = 2 => по две реплики у каждой партиции
Реплики одной партиции не могут находиться в одном брокере, иначе если отвалится такой брокер, то мы теряем всю партицию
![image](https://github.com/user-attachments/assets/d2f780a0-3d46-4655-a3d2-1165b841cceb)

## Leader replicas

![image](https://github.com/user-attachments/assets/8594d117-1cde-480e-ba56-022c4fc64ba0)

![image](https://github.com/user-attachments/assets/19addca1-3984-4675-a991-1ba73e4fde14)

## Синхронизация Leader & Follower
Назначаем ISR (in-sync replicas) реплики, обычно их количество = replicas_count - 1

### Потому что если сделать 4/4 ISR реплики и если отвалится хоть одна, тогда Producer не сможет ничего записывать вообще

И при записи сообщения в Leader оно записывается СИНХРОННО в ISR реплики

### ISR реплика - надежный кандидат на замену Leader, если он отвалится
![image](https://github.com/user-attachments/assets/e2d71dde-0a7c-429b-8b36-12e41d427697)

## ACKS
Producer ожидает подтверждение записи сообщения от брокеров
- 0 - не ждёт вовсе
- 1 - ждёт от Leader реплики
- -1(all) - ждёт от всех ISR реплик, включая Leader
![image](https://github.com/user-attachments/assets/7b632c06-2a5f-415d-ad07-07f25db63a18)
